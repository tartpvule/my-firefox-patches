// Bug 1332194 - Re-enable installing unverified addons
// https://bugzilla.mozilla.org/show_bug.cgi?id=1332194
// Bug 1475374 - xpinstall.signatures.required=false fails to allow unsigned legacy add-on in 60.1.0esr (32-bit)
// https://bugzilla.mozilla.org/show_bug.cgi?id=1475374
(function mod_AddonSettings(JSM) {
	const XPCOMUtils = JSM.XPCOMUtils;
	const AddonSettings = JSM.AddonSettings;
	const pObject = AddonSettings.constructor;

	const PREF_SIGNATURES_REQUIRED = "xpinstall.signatures.required";
	const PREF_LANGPACK_SIGNATURES = "extensions.langpacks.signatures.required";
	const PREF_ALLOW_LEGACY = "extensions.legacy.enabled";

	let newAddonSettings = pObject();
	let keys = Reflect.ownKeys(AddonSettings);
	for (let i = 0, l = keys.length; i < l; i++) {
		let key = keys[i];

		// Make them respect the preferences
		if (key === "REQUIRE_SIGNING") {
			XPCOMUtils.defineLazyPreferenceGetter(newAddonSettings, "REQUIRE_SIGNING", PREF_SIGNATURES_REQUIRED, false);
		} else if (key = "LANGPACKS_REQUIRE_SIGNING") {
			XPCOMUtils.defineLazyPreferenceGetter(newAddonSettings, "LANGPACKS_REQUIRE_SIGNING", PREF_LANGPACK_SIGNATURES, false);
		} else if (key === "ALLOW_LEGACY_EXTENSIONS") {
			XPCOMUtils.defineLazyPreferenceGetter(newAddonSettings, "ALLOW_LEGACY_EXTENSIONS", PREF_ALLOW_LEGACY, true);
		} else {
			let desc = Reflect.getOwnPropertyDescriptor(AddonSettings, key);
			desc.configurable = true;
			desc.enumerable = true;
			if ('writable' in desc) {
				desc.writable = true;
			}
			Reflect.defineProperty(newAddonSettings, key, desc);
		}
	}

	JSM.AddonSettings = newAddonSettings;
})(Components.utils.import("resource://gre/modules/addons/AddonSettings.jsm", {}));
